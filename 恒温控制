#include<reg51.h>
#include<intrins.h>
#define uchar unsigned char
#define uint unsigned int  
#define fosc 11059200                  	//??????? 
#define timer1ms 1000
//#define on 0
//#define off 1	
                   	 
sbit DQ = P3^3;     					//????????      //DS18B20???
bit sflag;						   		//DS18B20?????                           ??? 
uint scnt = 0;
uchar buf[2];



sbit RS = P3^0;							//LCD????????? 
sbit RW = P3^1;
sbit EP = P3^2; 
uchar code dis1[] = {"Now:__ C        "};
uchar code dis2[] = {"       Set:__ C"};
	
/*                
void delay(uint k);                 	//?????? 
uchar scankey(void);                	//???? 
bit reset_DS18B20(void);            			//DS?????? 
void write_DS18B20(uchar value);    			//?DS????
uchar read_DS18B20(void);          			//??DS????????? 
void T0_ISR(void); interrupt 1			//DS?????? 
void delay1(uchar ms);					//LCD????? 
uchar busy_check(void);					//LCD?????? 
void lcd_wcmd(uchar cmd);				//???????LCD 
void led_pos(uchar pos);				//??????
void lcd_wdat(uchar dat);				//?????????LCD 
void lcd_disp(void);					//???????? 
void lcd_init(void);					//LCD?????
 */





//???? (k =100   --> 10us ??) 
void delay(uint k)
{
	uint m,n;
	for(m=0;m<k;m++)    
		for(n=0;n<120;n++);
}





//???? 
uchar scankey(void)                                
{
	uchar temp,temp1,key;
	temp = P1;
	temp &= 0x0F ;
	switch(temp)
	{
		case 0x0E:
		{	
			P1 = 0xF0;
			delay(100);
			temp1 = P1;
			temp1 &= P1;
			switch(temp1)
			{
				case 0x70:	key =  0;	break;
				case 0xB0:	key =  1;	break;
				case 0xD0:	key =  2;	break;
				case 0xE0:	key =  3;	break;
				default: 	key =  0;	break;			   
			}
			P1 = 0x0F;
			break;
		}
		case 0x0D:
		{	
			P1 = 0xF0;
			delay(100);
			temp1 = P1;
			temp1 &= P1;
			switch(temp1)
			{
				case 0x70:	key =  4;	break;
				case 0xB0:	key =  5;	break;
				case 0xD0:	key =  6;	break;
				case 0xE0:	key =  7;	break;
				default: 	key =  0;	break;			   
			}
			P1 = 0x0F;
			break;
		}
		case 0x0B:
		{	
			P1 = 0xF0;
			delay(100);
			temp1 = P1;
			temp1 &= P1;
			switch(temp1)
			{
				case 0x70:	key =  8;	break;
				case 0xB0:	key =  9;	break;
				case 0xD0:	key = 10;	break;
				case 0xE0:	key = 11;	break;
				default: 	key =  0;	break;			   
			}
			P1 = 0x0F;
			break;
		}
		case 0x07:
		{	
			P1 = 0xF0;
			delay(100);
			temp1 = P1;
			temp1 &= P1;
			switch(temp1)
			{
				case 0x70:	key = 12;	break;
				case 0xB0:	key = 13;	break;
				case 0xD0:	key = 14;	break;
				case 0xE0:	key = 15;	break;
				default: 	key =  0;	break;			   
			}
			P1 = 0x0F;
			break;
		}
		default:			key =  0;	break;
	}
	return key;
} 




//DS18B20???? 
bit reset_DS18B20(void)            //DS?????? 
{
	uchar i;
	DQ = 0;
	for(i=255; i>0; i--);
	DQ = 1; 
	for(i=60; i>0; i--);
	for(i=255; i>0; i--);
	return DQ;
}


void write_DS18B20(uchar value)   //?DS????
{
	uchar i,j;
	for(i=0; i<8; i++)
	{
		if((value & 0x01) == 0)
		{
			DQ = 0;						//DQ ???? 
			for(j=35; j>0; j--);		//?????40us 
			DQ = 1;						//DQ ???? 
		}
		else 
		{
			DQ = 0;
			_nop_();					//?????15us 
			_nop_();
			_nop_();
			_nop_();
			DQ = 1;						//DQ ???? 
			for(j=35; j>0; j--);		//?????45us			
		}
		value >>= 1;
	}
}


uchar read_DS18B20(void)          //??DS????????? 
{
	uchar i,j,temp = 0;
	for(i=0; i<8; i++)
	{
		temp >>= 1;
		DQ = 0;					//DQ ???? 
		_nop_();				//?????10us?????
		_nop_();
		_nop_();
		_nop_();
		DQ= 1;					//DQ ???? 
		for(j=15; j>0; j--);	//????
		if(DQ == 1) 				//??DQ???????? 
		{
			temp = temp | 0x80;
		}
		else
		{
			temp = temp | 0x00;
		}
		for(j=20; j>0; j--);	//????	
			//???????	
	}
	 	return temp;
}





//DS18B20????,?? 
void T0_ISR(void) interrupt 1
{
	uchar x;                                    //????x,result
	uint result;
	TH0 = (65536-fosc/12/timer1ms)/256;			//T0??1ms?????TH0,TL0 ,???? 
	TL0 = (65536-fosc/12/timer1ms)%256;
	//LED?????? 
	scnt ++;
	if(scnt == 1000)
	{
		scnt = 0;	
		while(reset_DS18B20());						//??DS18B20
		write_DS18B20(0xcc);
		write_DS18B20(0xbe);							//?DS18B20?????
		buf[0] = read_DS18B20();						//?DS18B20??? 
		buf[1] = read_DS18B20();
		                                        //!!!!!!!!!//????????:??????????
		                                        
		                                        
		                                        
		sflag = 0;
		if((buf[1] & 0xF8) != 0x00)				//???????? 
		{
			sflag = 1;
			buf[1] = ~buf[1];					//????,?1?? 
			buf[0] = ~buf[0];
			result = buf[0] + 1;
			buf[0] = result;
			if(result > 255) buf[1]++; 
		}  
		buf[1] <<= 4;							//???????? 
		buf[1] &= 0x70;
		x = buf[0];
		x >>= 4;
		x &= 0x70;
		buf[1] |= x;
		x = 2;
		result = buf[1];
		
		
//	EG:	while(result/10)                        //????????????
//	 	{
//	 		LEDBuffer[x] = result % 10;
//	 		result = result / 10;
//	 		x ++;	
//		}
//		LEDBuffer[x] = result;
//		if(sflag == 1)							//?????,????????"-"? 
//				LEDBuffer[x + 1] = 17;
//		x = buf[0] & 0x0f;
//		x <<= 1;
//		LEDBuffer[0] = (dotcode[x]) % 10;		//???????????? 
//		LEDBuffer[1] = (doctode[x]) / 10;
		while(reset_DS18B20());						//??DS18B20b 
		write_DS18B20(0xcc);
		write_DS18B20(0x44);							//???????? 	 
	}  
} 





//LCD ???? 
void delay_(uchar ms)
{
	uchar i;
	while( ms-- )
	{
		for(i = 0; i < 120; i ++);	
	} 
} 


uchar busy_check(void)
{
	uchar LCD_Status;
	RS = 0;
	RW = 1;
	EP = 1;
	_nop_();
	_nop_();
	_nop_();
	_nop_();
	LCD_Status = P2 & 0x80;
	EP = 0;
	return LCD_Status;
}


void lcd_wcmd(uchar cmd) 				//???????LCD 
{
	while(busy_check());				//??LCD?? 
	RS = 0;
	RW = 0;
	EP = 0;
	_nop_();
	_nop_();
	P2 = cmd;
	_nop_();
	_nop_();
	_nop_();
	_nop_();
	EP = 1;
	_nop_();
	_nop_();
	_nop_();
	_nop_();
	EP = 0;	
} 


void lcd_pos(uchar pos) 				//??????
{
	lcd_wcmd( pos | 0x80);				//??LCD??????? 
} 


void lcd_wdat(uchar dat) 				//?????????LCD
{
	while(busy_check());
	RS = 1;
	RW = 0;
	EP = 0;
	P2 = dat;
	_nop_();
	_nop_();
	_nop_();
	_nop_();
	EP = 1;
	_nop_();
	_nop_();
	_nop_();
	_nop_(); 
	EP = 0;	
} 
 
void lcd_disp(void) 					//???????? 
{
	uchar i;
	lcd_pos(0x41);
	i = 0;
	while(dis1[i] != '\0')
	{
		lcd_wdat(dis1[i]);
		i ++;
	}
	lcd_pos(0x41);
	i = 0;
	while(dis2[i] != '\0');
	{
		lcd_wdat(dis2[i]);	
		i ++;
	}		
} 


void lcd_init(void)						//LCD?????
{
	lcd_wcmd(0x38);						//???????16*2?,5*7??,8????? 
	delay_(1);
	lcd_wcmd(0x0f);						//0x0f ח??????,??????? 
	delay_(1);
	lcd_wcmd(0x06);						//0x06 ח??????1 
	delay_(1);
//	lcd_wcmd(0x01);						//??LCD????? 
//	delay_(1);                            ????? 
}






int main()
{
	
	//????? 
	bit key_flag;                      //????????? ,??????????? 
	uchar temp,keynum,set=0,c=0,factnum=0;
	uchar swap[16]={1,2,3,-1,4,5,6,-1,7,8,9,-1,0,11,12,-1};
	



	
	//??LCD????
	lcd_init();						//LCD?????
	delay_(10);
	lcd_disp();						//????????             
//	while(1)                        //???? 
//	{
//		
//	}



	
	
	while(1)
	{	
		
		
		 
		 
		 
		//4*4??????(???????,(????)(??????????) 
		P1 = 0x0F;
//		while(1)
//		{
			temp = P1;                      //???????? 
			temp &= 0x0F;
			if(temp == 0x0F)   
			{
				key_flag = 0;
			}
			else
			{
				delay(100);             	//10ms???? 
				temp = P1;                  //????????
				temp &= 0x0F;				
			} 
			if(temp == 0x0F)
			{
				key_flag = 0;
			}
			else 
			{
				key_flag = 1;
				keynum = scankey();		
			}
//			while(temp != 0x0F)             
//			{                                      		//??????,??????factnum 
//				temp = P1;                         		//??-1,???? 
//				temp &= 0x0F;					   		//??12 ?c  , ????,??c   ?? 
//			} 									   		//??11 ?set,????,??set ??
			factnum = swap[keynum];
			if(factnum == 11) set++;
			if(set == 1 ) 
			{
				switch(swap[keynum])                   	//swap[16]={1,2,3,-1,4,5,6,-1,7,8,9,-1,0,11,12,-1}
				{
					case -1: factnum = 0; continue; 
					case 11: 
					{
						if(set == 2 ) 
						{
							set =0; 
							factnum = 0;
						}
						continue;
					}
					case 12: factnum = 0; break;              // !!!!!!!!!!!!!!!!!!!!!??,?display???,???? 
					default: break;
				}
			}
			else continue;
			if(set == 1 ) 
				;     //Дʾگ˽ìўلdi2אքֵ
//		}
		
		
		
		
		
		//??DS18B20????????
		TMOD = 0x01;
		TH0 = (65536-fosc/12/timer1ms)/256;			//T0??1ms?????TH0,TL0 
		TL0 = (65536-fosc/12/timer1ms)%256;	
		TR0 = 1;
		ET0 = 1;
		EA  = 1;
		while(reset_DS18B20());
		write_DS18B20(0xcc);
		write_DS18B20(0x44);
//		while(1)
//		{
//			
//			
//		} !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!?? 
//	T0_ISR();                                           //א׏گ˽һŜַԃ
		
		
		
		
		
		// ??? LCD ?????
		
		
		
		
		
		
		//??DS18B20??????????????,??????? 
		
		
		
		
		
		
		
	}
}
